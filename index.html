<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script>
      MathJax = {
        tex: {
          inlineMath: [['\\(', '\\)']]
        },
        svg: {
          fontCache: 'global'
        }
      };

      const fallback_url = "https://cdn.jsdelivr.net/npm/mathjax/es5/tex-svg.js"
      function mathjax_fallback() {
        const tag = document.getElementById("MathJax-script")
        const before = tag.nextElementSibling
        document.head.removeChild(tag)
        const cdn = document.createElement("script")
        cdn.setAttribute("type", "text/javascript")
        cdn.setAttribute("id", "MathJax-script")
        cdn.setAttribute("async", "")
        document.head.insertBefore(cdn, before)
        cdn.src = fallback_url
      }
    </script>
    <script type="text/javascript" id="MathJax-script"
      onerror="mathjax_fallback()" async src="mathjax/es5/tex-svg.js"></script>
    <script>
      "use strict"
      function rebase(value, inbase, outbase) {
        let output = [];
        for(let remainder of value) {
          if (remainder < 0)
            throw new Error("invalid input for base conversion")
          for(let digit = 0; digit < output.length; digit++) {
            remainder = inbase * output[digit] + remainder;
            output[digit] = remainder % outbase;
            remainder = Math.floor(remainder / outbase);
          }
          while(remainder) {
            output.push(remainder % outbase);
            remainder = Math.floor(remainder / outbase);
          }
        }
        return output.length ? output.reverse() : value.length ? [0] : [];
      }

      function translate(value, inalphabet, outalphabet) {
        let rebased = rebase(value.split("").map(x => inalphabet.indexOf(x)),
          inalphabet.length, outalphabet.length);
        return rebased.map(x => outalphabet[x]).join("");
      }

      const b2enc = x => translate(x.toString(), "0123456789", "01")
      const b2dec = x => parseInt(translate(x, "01", "0123456789"))
      const b3enc = x => translate(x.toString(), "0123456789", "012")
      const b3dec = x => parseInt(translate(x, "012", "0123456789"))
      const b322 = x => translate(x, "012", "01")

      function b3ltr(x) {
        let carry = 0;
        return x.split("").map(y => {
          let res = carry ? y === "0" ? "1" : "2" : y === "2" ? "1" : "0"
          carry ^= y === "1"
          return res
        }).join("") + (carry === 0 ? "" : "2")
      }

      function b3seq(x) {
        if (x.split("").reduce((a, b) => a && b === "0", true))
          throw new Error("invalid a_0 passed in")
        let seq = [x], b10 = [b3dec(x)], pre = [0, 0], cur = 0
        while (x !== "1") {
          const y = b3ltr(x)
          seq.push(y)
          b10.push(b3dec(y))
          x = y.replace(/^0*/, "")
          pre.push(cur += y.length - x.length)
        }
        return [seq, b10, pre]
      }

      function b3time(x, y, z) {
        return [...Array(x.length)].map((_, i) =>
            +(y[i] !== x[i]) - (i && y[i - 1] !== z[i - 1]))
          .reduce(([a, b], c) => [a + c, Math.max(b, a + c)], [0, 0])[1]
      }

      function sourcing(n) {
        const el = document.getElementById(`ex${n}`)
        el.classList.add("sourcing")
        el.querySelector(".ff").appendChild(document.createElement("div"))
      }

      function b2rtl(x) {
        const z = x.replace(/0*$/, "")
        let carry = 1;
        const res = z.split("").reverse().map(y => {
          const res = (y === "1") ^ (carry === 1)
          carry = Math.max(0, Math.min(2, carry + (y === "1" ? 1 : -1)))
          return res
        }).concat(carry ? carry === 1 ? [1] : [0, 1] : []).reverse().join("")
        return [res, x.length - z.length]
      }

      const b2c = (c, d) => (e => e * 2 === c ? 0 : e ? 1 : -1)(d === "1")

      function b2time(x, x0s, y) {
        /*
        time here...    v x0s <--- (potentially 0, time ignored by both carries)
               (+)    <-| |    b2time is trying to figure out how much
                1 0 0 0 1 0 <- carry changes caused by this row
              1 1 0 1 0 0   <- slow down carries caused by this one
                 (-)  |-|
        cancelled here  y0s (> 0 skipped by latter carry in first step)
        */
        const y0s = y.match(/0*$/)[0].length
        const v = x.split("").reverse().join("").slice(x0s)
        const w = y.split("").reverse().join("")
        let c0 = 1, c1 = 1
        return [y0s + 1, [...Array(w.length)].map((_, i) => {
          const delta0 = b2c(c0, v[i] || '0')
          c0 += delta0
          if (i <= y0s) return Math.abs(delta0)
          const delta1 = b2c(c1, w[i - 1])
          c1 += delta1
          return Math.abs(delta0) - Math.abs(delta1)
        }).reduce(([a, b], c) => [a + c, Math.max(b, a + c)], [0, 0])[1]]
      }

      window.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll("a").forEach(el => {
          if (el.childNodes.length === 1 && el.firstElementChild === null)
            el.innerText = el.innerText.trim()
        })

        // sourcing(#)
        // ex2
        const ex2el = document.getElementById("ex2")
        const ex2cols = document.querySelector("#ex2 .arrows")
        const ex2carry = document.querySelector("#ex2 .dots")
        const ex2style = window.getComputedStyle(ex2carry)
        const ex2timex = parseFloat(ex2style.getPropertyValue("--timing-x"))
        const ex2timey = parseFloat(ex2style.getPropertyValue("--timing-y"))
        function ex2digit() {
          const col = ex2cols.appendChild(document.createElement("div"))
          return col;
        }
        const ex2resize = new ResizeObserver(entries => entries.map(entry => {
          ex2el.style.setProperty("--cols", entry.contentRect.width / ex1sizing)
        }))
        ex2resize.observe(ex2cols)
        let ex2init = "", ex2val = "", ex2zeros = 0, ex2cover
        function ex2(b3) {
          window.cancelAnimationFrame(ex2warmup)
          window.clearTimeout(ex2cooldown)
          ex2cooldown = undefined
          for (let i of ex2timeouts) window.clearTimeout(i)
          ex2timeouts.clear()
          while (ex2carry.children.length > 1)
            ex2carry.removeChild(ex2carry.lastElementChild)
          const x = ex2val = b322(ex2init = b3)
          ex2zeros = 0
          ex2cover = ex1cover - 1
          while (ex2cols.children.length < ex2cover) ex2digit()
          while (ex2cols.children.length < x.length) ex2digit()
          ;[...ex2cols.children].forEach((y, i) => {
            if (i < x.length && x[x.length - 1 - i] === "1")
              y.classList.add("flip")
            else y.classList.remove("flip")
          })
          ex2el.classList.remove("started")
          ex2el.style.removeProperty("--zeros")
          ex2el.style.removeProperty("--min-bound")
          ex2el.style.removeProperty("--max-bound")
          ex2play.classList.remove("disabled")
        }
        function ex2carrier() {
          const col = ex2carry.appendChild(document.createElement("div"))
          for (let i = 2; i >= 0; i--) {
            const dot = col.appendChild(document.createElement("div"))
          }
          col.style.setProperty("--active", "1")
          col.classList.add("active")
          return col
        }
        let ex2timeouts = new Set(), ex2cooldown, ex2warmup;
        document.querySelector("#ex2 .reset").addEventListener("click", e => {
          ex2(ex2init)
        })
        const ex2run = auto => {
          if (ex2cooldown !== undefined) return
          const last = ex2carry.lastElementChild
          const carrier = ex2carrier()
          const prev = ex2val, zinit = ex2zeros
          const [update, shift] = b2rtl(ex2val)
          let carry = 1
          ex2val = update
          const znext = ex2zeros += shift
          ex2el.classList.add("started")
          while (ex2cols.children.length < ex2cover + ex2zeros) ex2digit()
          function goto(pos) {
            if (pos >= update.length + znext) {
              const full = parseInt(
                window.getComputedStyle(ex2el).getPropertyValue("--last-full"))
              if (pos === full) {
                carrier.classList.add("done")
                const timeout2 = window.setTimeout(() => {
                  ex2timeouts.delete(timeout2)
                  ex2carry.removeChild(carrier)
                }, ex2timex * 1000)
                ex2timeouts.add(timeout2)
                return
              }
            }
            ex2warmup = undefined
            while (ex2cols.children.length <= pos) ex2digit()
            carrier.style.setProperty("--digit", pos)
            if (last.previousElementSibling === null)
              ex2el.style.setProperty("--max-bound", pos)
            const timeout0 = window.setTimeout(() => {
              ex2timeouts.delete(timeout0)
              carrier.style.setProperty("--bound", pos)
              if (carrier.nextElementSibling === null)
                ex2el.style.setProperty("--min-bound", pos)
              if (carry === 1) {
                ex2cols.children[pos].classList.toggle("flip")
              }
              const cur = prev[prev.length - 1 - pos + zinit] === "1"
              if (cur * 2 !== carry) {
                carry += cur ? 1 : -1
                carrier.style.setProperty("--active", carry)
                const timeout1 = window.setTimeout(() => {
                  ex2timeouts.delete(timeout1)
                  goto(pos + 1)
                }, ex2timey * 1000)
                ex2timeouts.add(timeout1)
              } else {
                goto(pos + 1)
              }
            }, ex2timex * 1000)
            ex2timeouts.add(timeout0)
          }
          ex2warmup = window.requestAnimationFrame(() =>
            ex2warmup = window.requestAnimationFrame(() => {
              ex2el.style.setProperty("--zeros", znext)
              goto(znext)
            }
          ))
          const [ex2lagx, ex2lagy] = b2time(prev, shift, update)
          ex2cooldown = window.setTimeout(() => {
            ex2cooldown = undefined;
            if (auto) ex2run(true)
          }, (ex2timex * ex2lagx + ex2timey * ex2lagy) * 1000)
        }
        const ex2play = document.querySelector("#ex2 .play")
        ex2play.addEventListener("click", e => ex2run(false))
        document.querySelector("#ex2 .ff").addEventListener("click", e => {
          ex2play.classList.add("disabled")
          ex2run(true)
        })

        // ex1
        const ex1el = document.getElementById("ex1")
        const ex1cols = document.querySelector("#ex1 .dots")
        const ex1carry = document.querySelector("#ex1 .arrows")
        const ex1style = window.getComputedStyle(ex1carry)
        const ex1timex = parseFloat(ex1style.getPropertyValue("--timing-x"))
        const ex1timey = parseFloat(ex1style.getPropertyValue("--timing-y"))
        function ex1parse() {
          const active = ex1cols.querySelectorAll(".active")
          if (active.length === 0) {
            ex1cols.classList.add("zero")
            ex1cols.classList.remove("skips")
            ex1cols.style.removeProperty("--last")
            return
          }
          const last = active[active.length - 1]
          const digits = parseInt(last.style.getPropertyValue("--nth"))
          ex1cols.style.setProperty("--last", digits)
          if (digits !== active.length - 1) {
            ex1cols.classList.remove("zero")
            ex1cols.classList.add("skips")
            return
          }
          ex1cols.classList.remove("skips")
          const b3 = [...active].map(x => x.style.getPropertyValue("--active"))
            .join("")
          const b10 = b3dec(e0b03.value = b3)
          e0b10.value = b10
          if (b10 === 0) return ex1cols.classList.add("zero")
          ex0(b3)
        }
        function ex1digit() {
          const col = ex1cols.appendChild(document.createElement("div"))
          col.style.setProperty("--nth", ex1cols.children.length - 1)
          for (let i = 2; i >= 0; i--) {
            const dot = col.appendChild(document.createElement("div"))
            dot.addEventListener("click", (i => e => {
              if (ex1el.classList.contains("started")) return
              col.style.setProperty("--active", i)
              col.classList.add("active")
              ex1parse()
            })(i))
          }
          col.addEventListener("click", e => {
            if (ex1el.classList.contains("started") || e.target !== col) return
            col.style.removeProperty("--active")
            col.classList.remove("active")
            ex1parse()
          })
          return col;
        }
        const ex1cover = window.getComputedStyle(ex1el)
          .getPropertyValue("--cols-cover")
        const ex1sizing = ex1digit().getBoundingClientRect().width
        for (var i = 1; i < ex1cover; i++) ex1digit()
        const ex1resize = new ResizeObserver(entries => entries.map(entry => {
          ex1el.style.setProperty("--cols", entry.contentRect.width / ex1sizing)
        }))
        ex1resize.observe(ex1cols)
        let ex1init = "", ex1val = "", ex1next = "", ex1pressure = 0
        function ex1(x) {
          window.cancelAnimationFrame(ex1warmup)
          window.clearTimeout(ex1cooldown)
          ex1cooldown = undefined
          for (let i of ex1timeouts) window.clearTimeout(i)
          ex1timeouts.clear()
          while (ex1carry.children.length > 1)
            ex1carry.removeChild(ex1carry.lastElementChild)
          while (ex1cols.children.length < x.length) ex1digit()
          ex1val = ex1init = x
          ex1next = b3ltr(x)
          ;[...ex1cols.children].forEach(y => {
            y.style.removeProperty("--active")
            y.classList.remove("active")
          })
          x.split("").map((y, i) => {
            ex1cols.children[i].style.setProperty("--active", y)
            ex1cols.children[i].classList.add("active")
          })
          ex1el.classList.remove("started")
          ex1el.style.removeProperty("--zeros")
          ex1el.style.removeProperty("--min-bound")
          ex1el.style.removeProperty("--max-bound")
          ex1el.style.setProperty("--pressure", ex1pressure = x.length)
          ex1cols.style.removeProperty("--last")
          ex1cols.classList.remove("zero")
          ex1cols.classList.remove("skips")
          ex1play.classList.remove("disabled")
        }
        let ex1timeouts = new Set(), ex1cooldown, ex1warmup;
        document.querySelector("#ex1 .reset").addEventListener("click", e => {
          ex1(ex1init)
        })
        const ex1run = auto => {
          if (ex1cols.classList.contains("zero") ||
            ex1cols.classList.contains("skips")) return
          if (ex1cooldown !== undefined) return
          const last = ex1carry.lastElementChild
          const carrier = ex1carry.appendChild(document.createElement("div"))
          const prev = ex1val
          const update = ex1val = ex1next
          const next = ex1next = b3ltr(ex1val)
          const zlo = prev.match(/^0*/)[0].length
          const zhi = update.match(/^0*/)[0].length
          ex1el.classList.add("started")
          carrier.style.setProperty("--digit", -1)
          carrier.style.setProperty("--bound", -1)
          function goto(pos) {
            ex1warmup = undefined
            while (ex1cols.children.length <= pos) ex1digit()
            carrier.style.setProperty("--digit", pos)
            if (last.previousElementSibling === null)
              ex1el.style.setProperty("--max-bound", pos)
            if (pos >= ex1pressure)
              ex1el.style.setProperty("--pressure", ex1pressure = pos + 1)
            const timeout0 = window.setTimeout(() => {
              ex1timeouts.delete(timeout0)
              carrier.style.setProperty("--bound", pos)
              if (carrier.nextElementSibling === null)
                ex1el.style.setProperty("--min-bound", pos)
              if (pos > zlo && pos <= zhi) {
                ex1el.style.setProperty("--zeros", pos)
              }
              if (prev[pos] === "1") {
                carrier.classList.toggle("flip")
              }
              if (prev[pos] !== update[pos]) {
                ex1cols.children[pos].style.setProperty("--active", update[pos])
                ex1cols.children[pos].classList.add("active")
                if (prev[pos] !== undefined) {
                  const timeout1 = window.setTimeout(() => {
                    ex1timeouts.delete(timeout1)
                    if (pos < update.length - 1) goto(pos + 1)
                    else ex1carry.removeChild(carrier)
                  }, ex1timey * 1000)
                  ex1timeouts.add(timeout1)
                } else {
                  ex1carry.removeChild(carrier)
                }
              } else if (pos < update.length - 1) {
                goto(pos + 1)
              } else if (pos == update.length - 1) {
                ex1carry.removeChild(carrier)
              }
            }, ex1timex * 1000)
            ex1timeouts.add(timeout0)
          }
          ex1warmup = window.requestAnimationFrame(() =>
            ex1warmup = window.requestAnimationFrame(() => goto(
              auto ? 0 : parseInt(
                window.getComputedStyle(last).getPropertyValue("--lead")))))
          const ex1lag = b3time(prev, update, next)
          carrier.style.setProperty("--lag", ex1lag)
          ex1cooldown = window.setTimeout(() => {
            ex1cooldown = undefined;
            if (auto) ex1run(true)
          }, (ex1timex + ex1timey * ex1lag) * 1000)
        }
        const ex1play = document.querySelector("#ex1 .play")
        ex1play.addEventListener("click", e => ex1run(false))
        document.querySelector("#ex1 .ff").addEventListener("click", e => {
          ex1play.classList.add("disabled")
          ex1run(true)
        })

        // ex0
        const ex0nt = x => { ex1(x); ex2(x) }
        const e0b10 = document.getElementById("ex0base10")
        const e0b02 = document.getElementById("ex0base02")
        const e0b03 = document.getElementById("ex0base03")
        const ex0el = document.getElementById("ex0")
        const selall = e => { e.target.select() }
        const ex0pad = 8
        function ex0(x) {
          const [seq, b10, pre] = b3seq(x)
          const s10 = b10.map(x => x.toString())
          const lines = seq.map((x, i) => " ".repeat(pre[i]) + x)
          const align = ex0pad + lines.slice(-1)[0].length + Math.max(
            ...s10.map(x => x.length))
          ex0el.innerHTML = ""
          ex0el.appendChild(document.createTextNode(lines.map((x, i) => {
            const splits = x.split("1")
            const carry = splits.map((y, j) =>
              y + (j === splits.length - 1 ? "" : "1"))
            const eol = " ".repeat(align - x.length - s10[i].length) + s10[i] +
              (i === lines.length - 1 ? "" : "\n")
            return carry.length % 2 ?
              carry.slice(0, -1).concat([carry[carry.length - 1] + eol]) :
              i === lines.length - 1 ? carry.concat([eol]):
              carry.slice(0, -1).concat(
                [carry[carry.length - 1] + " ", eol.slice(1)])
          }).reduce((a, b) => {
            if (b.length === 1) return a + b[0]
            ex0el.appendChild(document.createTextNode(a + b[0]))
            for (let i = 1; i < b.length - 1; i++) {
              if (i % 2)
                ex0el.appendChild(document.createElement("u")).innerText = b[i]
              else ex0el.appendChild(document.createTextNode(b[i]))
            }
            return b[b.length - 1]
          }, "")))
          ex0nt(x)
        }

        e0b10.addEventListener("focus", selall, { "passive": true })
        e0b02.addEventListener("focus", selall, { "passive": true })
        e0b03.addEventListener("focus", selall, { "passive": true })
        e0b10.addEventListener("input", e => {
          const x = e0b10.value || e0b10.placeholder
          const y = b3enc(x)
          e0b02.value = e0b10.value && b2enc(x)
          e0b03.value = e0b10.value && y
          ex0(y)
        }, { "passive": true })
        e0b02.addEventListener("input", e => {
          const x = b2dec(e0b02.value || e0b02.placeholder)
          const y = b3enc(x)
          e0b03.value = e0b02.value && y
          e0b10.value = e0b02.value && x
          ex0(y)
        }, { "passive": true })
        e0b03.addEventListener("input", e => {
          const x = e0b03.value || e0b03.placeholder
          const y = b3dec(x)
          e0b02.value = e0b03.value && b2enc(y)
          e0b10.value = e0b03.value && y
          ex0(x)
        }, { "passive": true })
        const init = e0b03.value || e0b03.placeholder
        try {
          ex0(init)
        } finally {
          ex2(init)
        }
      })
    </script>
  </head>
  <body>
    <div class="content">
      <div class="conjecture">
        For the sequence
        \begin{align}
          a_0&\in\mathbb{N}+1=\{1,2,3,\dots\}\\
          a_{k+1}&= \left\{
            \begin{array}{rl}
              a_k \div 2 & \quad2\mid a_k \\
              3a_k+1 & \quad2\nmid a_k
            \end{array}
          \right.
        \end{align}
        the Collatz conjecture states that
        \begin{equation}
          \forall\,a_0\,\exists\,k\ \text{such that}\ a_k=1
        \end{equation}
      </div>
      <hr>

      The goal of this page is to make the Collatz sequence's mapping easier to
      think about. The lowest-context, longhand formulation is in binary.
      Repeatedly:
      <ol>
        <li>Remove trailing 0s (removes factors of 2 until odd)</li>
        <li>Append 1 to the end of the number (\(=2a_k+1\))</li>
        <li>Add the result to the previous number (\(=3a_k+1\))</li>
      </ol>
      For example (via
      <a href="https://en.wikipedia.org/w/index.php?title=Collatz_conjecture&oldid=1298684967#Example">
        Wikipedia
      </a>), using \(7=111_2\)
<pre>
         111         7
        <u>111<b>1</b></u>
       1011<s>0</s>        11
      <u>1011<b>1</b></u>
     10001<s>0</s>         17
    <u>10001<b>1</b></u>
    1101<s>00</s>          13
   <u>1101<b>1</b></u>
  101<s>000</s>             5
 <u>101<b>1</b></u>
1<s>0000</s>                1
</pre>
      The rows in this method correspond to steps on odds, with evens grouped
      into removed columns. The process can also be rephrased in order to be
      convenient for a state-machine instead of manual computation. Above, the
      result depends on the (hidden) carry from the previous digit, the digit
      from step 1, and the digit from step 2. In an adder, the carry is the
      result's overflow from modulo 2, but step 2 can be hidden by changing the
      carry to mean the overflow plus the input digit. In this case, only the
      number and carry are being added and the carry is 0, 1, or 2, starting
      with 1 from the 1 appended in step 2.
      <br /><br />
      While base 2 simplifies division, base 3 simplifies the addition. Dividing
      by 2 in base 3 is most familiar as long division, where the remainder
      switches between 0 and 1 at each 1 digit in the input. If the input ends
      with a remainder, appending a 1 to the input accounts for \(3a_k + 1\) and
      appends a 2 to the output. Below, in the text format for the base 3
      process, digits with an incoming remainder denoted by an underline. In
      contrast to base 2, the rows in this version correspond to steps on evens,
      with steps on odds adding columns.
      <br /><br />

      Using \(a_0=\)
      <input type="number" value="7"  placeholder="7"  id="ex0base10">
      </input>
      \(=\)
      <input type="number" value="111" placeholder="111" id="ex0base02">
      </input>
      \(_2=\)
      <input type="number" value="21" placeholder="21" id="ex0base03">
      </input>
      \(_3\)

      <div id="ex2">
        <div class="play"></div>
        <div class="ff"></div>
        <div class="eos"></div>
        <div class="reset"></div>
        <div class="dots">
          <div class="active"><div></div><div></div><div></div></div>
        </div>
        <div class="arrows"></div>
      </div>

      <div id="ex1">
        <div class="play"></div>
        <div class="arrows"><div></div></div>
        <div class="ff"></div>
        <div class="reset"></div>
        <div class="dots zero"></div>
      </div>

      <pre id="ex0"></pre>

      These 3 representations are actually presented in reverse order of
      creation (GitHub releases for verified timestamps).
      <!-- https://archive.ph/0oOOV -->
      <a href="https://cdsmithus.medium.com/01d44cdfbe5a">
        This article by Chris Smith
      </a>
      was a part of the process in going from the base 3 visual to base 2. The
      repo name/URL is the random one suggested by GitHub to avoid
      <code>collatz(-new)*</code>.
    </div>
    <style>
      .content {
        --max-width-em: 40;
        max-width: calc(var(--max-width-em) * 1em);
        margin-left: auto;
        margin-right: auto;
      }

      .conjecture {
        text-align: center;
      }

      s {
        text-decoration: none;
        position: relative
      }

      s::after {
        content: '';
        position: absolute;
        width: 100%;
        left: 0;
        height: 0.15em;
        background: #000;
        top: 50%;
        transform: translateY(-50%);
      }

      input[type=number] {
        font-family: inherit;
        border-color: #aaa;
        border-width: 0 0 0.2em 0;
        outline: 0;
        text-align: right;
        font-size: inherit;
      }

      input[type=number]:focus {
        border-color: #007aff;
      }

      /* https://stackoverflow.com/a/4298216/3476782 */
      input:not(#ex0base10)::-webkit-outer-spin-button,
      input:not(#ex0base10)::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      input[type=number]:not(#ex0base10) {
        appearance: textfield;
      }

      #ex0base10 { width: 3em; }
      #ex0base02 { width: 5em; }
      #ex0base03 { width: 4em; }

      #ex0 {
        max-width: 100%;
        overflow-x: scroll;
      }

      @property --cols-cover {
        syntax: '<number>';
        inherits: true;
        initial-value: 1;
      }

      #ex1, #ex2 {
        --timing-x: 0.5;
        --timing-y: 0.5;
        --timing-x-s: calc(var(--timing-x) * 1s);
        --timing-y-s: calc(var(--timing-y) * 1s);
        --pressure: 0;
        --zeros: 0;
        --cols: 1;
        --max-bound: 0;
        --min-bound: 0;
        --scroll: calc(max(0, min(var(--pressure) - var(--cols),
          max(var(--zeros), min(
            var(--max-bound) + 1 - var(--cols), var(--min-bound))))));
        margin: 1em 0;
        position: relative;
        overflow-x: hidden;
      }

      #ex1 {
        --cols-cover: calc(round(down, (var(--max-width-em) - 1) / 3) - 1);
      }

      @property --last-full {
        syntax: '<number>';
        inherits: true;
        initial-value: 0;
      }

      #ex2 {
        /* not scrolling to follow carries since the number of zeros matters */
        --scroll: var(--zeros);
        --last-full: calc(round(down, var(--scroll) + var(--cols)));
        --overflow: calc(max(0, sign(var(--max-bound) + 1 - var(--last-full))));
      }

      .play {
        width: 2em;
        height: 2em;
        top: 1em;
        left: 1em;
        position: absolute;
        background: #007aff;
        border-radius: 100%;
        z-index: 1;
      }

      .play.disabled {
        background: #aaa;
      }

      .play::before {
        content: '';
        position: absolute;
        width: 0;
        height: 0;

        --symbol-height: 1em;
        --playback-color: #fff;
        --padding-value: 0.5em;
        --h: calc(var(--symbol-height) / 2);
        --w: calc(var(--symbol-height) * sqrt(3) / 2);
        border-color: transparent var(--playback-color);
        border-style: solid;
        border-width: var(--h) 0px var(--h) var(--w);

        --tri-offset: calc((sqrt(3) - 3 / 2) * var(--symbol-height) / 2);
        margin-top: var(--padding-value);
        margin-bottom: var(--padding-value);
        margin-left: calc(var(--padding-value) + var(--symbol-height) / 4);
        margin-right: calc(var(--padding-value) - var(--tri-offset));
      }

      .ff {
        width: 2em;
        height: 2em;
        top: 7em;
        left: 1em;
        position: absolute;
        background: #007aff;
        border-radius: 100%;
        z-index: 1;
      }

      .started .ff {
        display: none;
      }

      .ff::before, .ff::after {
        content: '';
        border-width: 0.6em;
        border-style: solid;
        border-color: transparent transparent transparent #fff;
        width: 0;
        height: 0;
        position: absolute;
        left: 0.6em;
        top: 0.4em;
      }

      .ff::after {
        left: 1.1em;
      }

      .reset {
        --back: red;
        width: 2em;
        height: 2em;
        top: 7em;
        left: 1em;
        position: absolute;
        background: var(--back);
        border-radius: 100%;
        display: none;
        z-index: 1;
      }

      #ex2 .ff, #ex2 .reset {
        top: 4em;
      }

      .started .reset {
        display: initial;
      }

      .reset::before {
        content: '';
        width: 0.8em;
        height: 0.8em;
        border-radius: 100%;
        position: absolute;
        margin: 0.4em;
        border: 0.2em solid #fff;
      }

      .reset::after {
        content: '';
        width: 0;
        height: 0;
        position: absolute;
        border-width: 0.4em 0.4em 0.1em 0.4em;
        border-style: solid;
        border-color: #fff var(--back) var(--back) var(--back);
        top: 0.6em;
        left: 1.1em;
        transform: rotate(-30deg);
      }

      #ex1 .arrows, #ex2 .dots {
        --digit: -1;
        --bound: -1;
        --lag: 0;
      }

      @property --lead {
        syntax: '<number>';
        inherits: true;
        initial-value: 0;
      }

      #ex1 .arrows > div {
        --lead: calc(max(0, min(
          var(--zeros) - 1,
          round(down, var(--scroll)),
          var(--bound) - 1 - round(
            up, var(--lag) * var(--timing-y) / var(--timing-x)))));
        transition: left var(--timing-x-s), transform var(--timing-y-s);
      }

      #ex2 .arrows > div {
        transition: transform var(--timing-y-s);
      }

      #ex1 .arrows > div {
        left: calc(4em + 3em * max(-1, var(--digit) - var(--scroll)));
        position: absolute;
      }

      #ex2 .arrows > div {
        display: inline-block;
      }

      .arrows > div {
        width: 2em;
        height: 2em;
        top: 4em;
        z-index: 1;
        transform: rotate(0deg);
      }

      #ex1 .arrows > div:first-child {
        --lead: calc(max(0, min(var(--zeros) - 1, round(down, var(--scroll)))));
      }

      .arrows > .flip {
        transform: rotate(180deg);
      }

      .arrows > div::before {
        content: '';
        position: absolute;
        width: 1.8em;
        height: 1.8em;
        border-width: 0 0.2em 0.2em 0;
        transform: rotate(45deg) scale(calc(1 / sqrt(2)));
        border-style: solid;
        border-color: #000;
      }

      .arrows > div::after {
        content: '';
        position: absolute;
        width: calc(0.2em / sqrt(2));
        height: calc(2em - 0.2em / sqrt(2));
        left: calc(1em - 0.1em / sqrt(2));
        background: #000;
      }

      #ex1 .dots {
        --last: -1;
        margin-left: 3em;
        text-wrap: nowrap;
        overflow-x: hidden;
      }

      #ex2 .arrows {
        margin: 3em;
        text-wrap: nowrap;
        overflow-x: hidden;
        text-align: right;
        direction: rtl;
      }

      #ex2 .dots {
        position: absolute;
        right: 1em;
        top: 0;
      }

      #ex2 .dots > div:first-child {
        --active: 1;
      }

      #ex2 .dots > div:not(:first-child) {
        position: absolute;
        top: 0;
        left: calc(-3em - 3em * max(-1, var(--digit) - var(--scroll)));
        transition: left var(--timing-x-s);
      }

      #ex2 .dots > div:not(:first-child).done {
        left: calc(-2em - 3em * var(--cols));
      }

      #ex1 .dots > div:first-child {
        margin-left: calc(var(--scroll) * -3em);
        transition: margin-left var(--timing-x-s);
      }

      #ex2 .arrows > div:first-child {
        margin-right: calc(1em + var(--scroll) * -3em);
        transition: transform var(--timing-y-s), margin-right var(--timing-x-s);
      }

      /* https://stackoverflow.com/a/32993828 */
      #ex1 .dots > div {
        --error-opacity: 0.2;
        display: inline-block;
        position: relative;
        pointer-events: none;
      }

      .dots > div > div {
        width: 2em;
        height: 2em;
        background: #aaa;
        border-radius: 100%;
        margin: 1em 0 1em 1em;
        pointer-events: auto;
      }

      #ex2 .arrows > div {
        margin: 1em 1em 1em 0;
        text-align: initial;
      }

      .dots > .active::after, .eos {
        content: '';
        position: absolute;
        width: 2em;
        height: 2em;
        left: 1em;
        top: calc(7em - var(--active) * 3em);
        transition: top var(--timing-y-s);
        background: green;
        border-radius: 100%;
        pointer-events: auto;
      }

      .eos {
        transition: initial;
        top: 7em;
        opacity: 0.5;
        z-index: calc(-1 + 3 * var(--overflow));
      }

      .eos::before, .eos::after {
        content: '';
        position: absolute;
        background: #fff;
        width: calc(0.2em / sqrt(2));
        height: 1.2em;
        margin: 0.4em calc(1em - 0.1em / sqrt(2));
        transform: rotate(45deg);
      }

      .eos::after {
        transform: rotate(-45deg);
      }

      #ex2::before {
        content: '';
        background: #fff;
        position: absolute;
        left: 0;
        top: 0;
        width: 3em;
        z-index: 1;
        height: calc(6.5em + 3em * var(--overflow));
      }

      #ex1 .dots > div::before {
        content: '';
        position: absolute;
        width: 100%;
        top: 0.5em;
        bottom: 0.5em;
        left: 0.5em;
        z-index: -1;
        background: red;
        opacity: 0;
      }

      #ex1 .dots > div:not(.active)::before {
        opacity: calc(clamp(
          0, abs(var(--last)) - var(--nth), var(--error-opacity)));
      }

      #ex1 .dots.zero > .active::before,
      #ex1 .dots.zero > .active + div::before {
        opacity: var(--error-opacity);
        bottom: 3.5em;
      }

      .sourcing {
        padding-bottom: 2em;
        --timing-x: 0.2 !important;
        --timing-y: 0.2 !important;
        overflow-x: initial !important;
      }

      #ex2.sourcing {
        padding-top: 1px;
      }

      #ex2.sourcing .arrows {
        transform: translateY(-1px);
      }

      .sourcing::after {
        content: 'kentslaney.github.io/ideal-bassoon';
        position: absolute;
        font-size: 2em;
        transform: translate(2em, -0.5em);
      }

      .sourcing .ff > div {
        position: absolute;
        width: 100%;
        height: 100%;
        background: inherit;
        left: -8em;
      }
    </style>
  </body>
</html>
